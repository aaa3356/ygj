<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>계량 실패! 양과자점!</title>
<style>
  @font-face{
    font-family:'Galmuri11';
    src:url('./Galmuri11.woff2') format('woff2');
    font-display:swap;
  }
  html, body {
    margin:0; height:100%;
    background:#f8f3ff;
    display:flex; align-items:center; justify-content:center;
    font-family:'Galmuri11','Malgun Gothic',Arial,sans-serif;
    -webkit-touch-callout:none; -webkit-user-select:none; user-select:none;
  }
  #wrap { position:relative; }
  canvas {
    image-rendering: pixelated;
    border:8px solid #e9def6;
    box-shadow:0 8px 24px rgba(92,74,114,0.2);
    display:block;
  }
  /* 모바일 터치패드/오디오 버튼 */
  .pad {
    position:absolute; bottom:10px; width:34%; height:64px;
    background:rgba(255,255,255,0.5); border:2px solid #e9def6; color:#5C4A72;
    display:none; align-items:center; justify-content:center; border-radius:10px;
    font-size:22px;
  }
  .pad-left{ left:10px; } .pad-right{ right:10px; }
  .btn-audio{
    position:absolute; top:10px; right:10px; width:44px; height:44px;
    background:rgba(255,255,255,0.7); border:2px solid #e9def6; border-radius:8px;
    display:none; align-items:center; justify-content:center; font-size:20px; color:#5C4A72;
  }
  .mobile .pad, .mobile .btn-audio{ display:flex; }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>
  <div class="pad pad-left"  id="padL">◀</div>
  <div class="pad pad-right" id="padR">▶</div>
  <div class="btn-audio" id="btnAudio">🔊</div>
</div>
<script>
/* ====== 캔버스/렌더 ====== */
const BASE_W=512, BASE_H=384;
const DPR=Math.max(1, Math.floor(window.devicePixelRatio||1));
const wrap=document.getElementById('wrap');
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d',{alpha:true});
function setupCanvas(){
  canvas.width=BASE_W*DPR; canvas.height=BASE_H*DPR;
  ctx.setTransform(DPR,0,0,DPR,0,0);
  ctx.imageSmoothingEnabled=false;
  fitCanvas();
}
function fitCanvas(){
  const vw=Math.min(window.innerWidth, 900);
  const vh=Math.min(window.innerHeight, 900);
  let scale=Math.min(vw/BASE_W, vh/BASE_H);
  if ('ontouchstart' in window) scale=Math.min(scale, 1.2);
  canvas.style.width=(BASE_W*scale)+'px';
  canvas.style.height=(BASE_H*scale)+'px';
  wrap.style.width=canvas.style.width;
  wrap.style.height=canvas.style.height;
}
setupCanvas(); addEventListener('resize', fitCanvas);
if ('ontouchstart' in window) document.body.classList.add('mobile');

/* ====== 전역 상태 ====== */
let state='title'; // title | play | victory | gameover
let stage=1, progress=0, goal=12, cavity=0, score=0;
const TARGET_SCORE=10000;
let hi=Number(localStorage.getItem('ygj_hi_full')||0);
let msg='', msgTimer=0;

/* ====== 입력(키보드+터치) ====== */
const key={}; let touchLeft=false, touchRight=false;
addEventListener('keydown', e=>{
  key[e.key]=true;
  if ((e.key===' '||e.key==='Enter')){
    if (state==='title') startGame();
    else if (state==='gameover' || state==='victory') goTitle();
  }
  if (e.key==='m'||e.key==='M') toggleAudio();
  if (e.key==='[') volDown(); if (e.key===']') volUp();
});
addEventListener('keyup', e=> key[e.key]=false);
function bindPad(el,setter){
  const on=()=>setter(true), off=()=>setter(false);
  el.addEventListener('pointerdown', e=>{ e.preventDefault(); on(); });
  addEventListener('pointerup', off); addEventListener('pointercancel', off);
  el.addEventListener('pointerleave', off);
  el.addEventListener('touchstart', e=>{ e.preventDefault(); on(); }, {passive:false});
  el.addEventListener('touchend', e=>{ e.preventDefault(); off(); }, {passive:false});
}
bindPad(document.getElementById('padL'), v=>touchLeft=v);
bindPad(document.getElementById('padR'), v=>touchRight=v);

/* ====== 오디오(밝은 칩튠 + SFX + 볼륨 단계) ====== */
let audioCtx=null, masterGain=null;
let audioEnabled=true;
const volumeSteps=[0,0.3,0.6,1.0]; let volIdx=3; // 기본 100%
function ensureAudio(){
  if (!audioCtx){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    masterGain=audioCtx.createGain();
    masterGain.gain.value=0.36*volumeSteps[volIdx]; // 충분히 크게
    masterGain.connect(audioCtx.destination);
  }
}
function updateMasterGain(){ if (masterGain) masterGain.gain.value=0.42*volumeSteps[volIdx]; }
function volUp(){ volIdx=Math.min(volumeSteps.length-1, volIdx+1); updateMasterGain(); }
function volDown(){ volIdx=Math.max(0, volIdx-1); updateMasterGain(); }
function toggleAudio(){ audioEnabled=!audioEnabled; if (!audioEnabled) stopChiptune(); else if(state==='play') startChiptune(); }
function noteToFreq(m){ return 440*Math.pow(2,(m-69)/12); }
function playTone(freq, dur=0.12, type='square', gain=0.16){
  if (!audioEnabled) return; ensureAudio();
  const t=audioCtx.currentTime;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.value=freq;
  g.gain.value=gain*volumeSteps[volIdx];
  o.connect(g); g.connect(masterGain);
  o.start(t); g.gain.setValueAtTime(g.gain.value,t);
  g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
  o.stop(t+dur+0.02);
}
/* 칩튠 루프 */
let seqTimer=null, step=0;
const tempo=132, stepSec=(60/tempo)/2;
const leadSeq=[72,74,76,79, 79,76,74,72, 72,74,76,79, 81,79,76,74];
const bassSeq=[36,36,36,43, 36,36,36,43, 36,36,36,43, 38,38,38,43];
function startChiptune(){
  if (!audioEnabled) return; ensureAudio(); stopChiptune(); updateMasterGain();
  step=0;
  seqTimer=setInterval(()=>{
    playTone(noteToFreq(leadSeq[step%leadSeq.length]),0.11,'square',0.20);
    if (step%2===0) playTone(noteToFreq(bassSeq[step%bassSeq.length]),0.14,'triangle',0.18);
    playTone(7200,0.02,'square',0.08); // 하이햇 펄스
    step=(step+1)%16;
  }, stepSec*1000);
}
function stopChiptune(){ if (seqTimer){ clearInterval(seqTimer); seqTimer=null; } }
function sfx(type){
  if (!audioEnabled) return;
  if (type==='ok')   playTone(880,0.07,'square',0.18);
  if (type==='bad')  playTone(200,0.12,'triangle',0.20);
  if (type==='stage'){ playTone(523,0.07); setTimeout(()=>playTone(659,0.07),90); setTimeout(()=>playTone(784,0.09),180); }
  if (type==='win'){ playTone(660,0.08); setTimeout(()=>playTone(880,0.1),120); setTimeout(()=>playTone(1320,0.12),260); }
}
const btnAudio=document.getElementById('btnAudio');
btnAudio.addEventListener('click', ()=>{
  volUp(); ensureAudio(); updateMasterGain(); if (state==='play') startChiptune();
});

/* ====== 진동 ====== */
function vibrate(ms){ if (navigator.vibrate) navigator.vibrate(ms); }

/* ====== 스프라이트 로더(픽셀 이모지) ====== */
const SPRITES={ items:{}, player:{} };
const spritePaths={
  items:{
    '거북이':'./sprites/turtle16.png',
    '토마토':'./sprites/tomato16.png',
    '버섯':'./sprites/mushroom16.png',
    '설탕':'./sprites/sugar16.png',
    '우유':'./sprites/milk16.png',
    '계란':'./sprites/egg16.png',
    '생크림':'./sprites/cream16.png',
    '복숭아':'./sprites/peach16.png',
    '젤라틴':'./sprites/gelatin16.png'
  },
  player:{
    idle:'./sprites/player_idle24.png',
    run1:'./sprites/player_run1_24.png',
    run2:'./sprites/player_run2_24.png'
  }
};
function loadImage(src){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=src; }); }
async function loadSprites(){
  for (const k in spritePaths.items){ try{ SPRITES.items[k]=await loadImage(spritePaths.items[k]); }catch(e){} }
  for (const k in spritePaths.player){ try{ SPRITES.player[k]=await loadImage(spritePaths.player[k]); }catch(e){} }
}
loadSprites();

/* ====== 배경: 연파랑/흰 스트라이프 + 패브릭 질감 + 핫핑크 별 ====== */
// 정확한 오각별(10포인트) — 이 함수 하나만 사용합니다.
function drawStar(c2d, cx, cy, outerR = 7, innerR = 3.2, fill = '#FF2E86', stroke = '#4d3d5a', rotation = 0){
  c2d.save();
  const ox = Math.round(cx) + 0.5; // 반픽셀 정렬(1px 스트로크 선명)
  const oy = Math.round(cy) + 0.5;
  c2d.translate(ox, oy);
  c2d.rotate(rotation);
  c2d.beginPath();
  for (let i = 0; i < 10; i++){
    const a = i * Math.PI / 5; // 36도 간격
    const r = (i % 2 === 0) ? outerR : innerR;
    const x = Math.cos(a) * r, y = Math.sin(a) * r;
    if (i === 0) c2d.moveTo(x, y); else c2d.lineTo(x, y);
  }
  c2d.closePath();
  c2d.fillStyle = fill; c2d.fill();
  c2d.strokeStyle = stroke; c2d.lineJoin = 'round'; c2d.lineWidth = 1; c2d.stroke();
  // 반짝 포인트(선택)
  c2d.fillStyle = 'rgba(255,255,255,0.7)';
  c2d.fillRect(-1, -Math.max(outerR - 3, 3), 2, 1);
  c2d.restore();
}
let bgCanvas=null, bgCtx=null;
function makeBG(){
  bgCanvas=document.createElement('canvas'); bgCanvas.width=BASE_W; bgCanvas.height=BASE_H;
  bgCtx=bgCanvas.getContext('2d'); bgCtx.imageSmoothingEnabled=false;

  // 스트라이프
  const stripeW=8;
  for (let x=0; x<BASE_W; x+=stripeW){
    bgCtx.fillStyle=( (x/stripeW)%2===0 ? '#EAF6FF' : '#FFFFFF' );
    bgCtx.fillRect(x,0,stripeW,BASE_H);
  }
  // 패브릭 디더링
  for (let y=0; y<BASE_H; y+=2){
    for (let x= (y%4===0 ? 0 : 2); x<BASE_W; x+=4){
      bgCtx.fillStyle='rgba(180,200,220,0.08)';
      bgCtx.fillRect(x,y,1,1);
    }
  }
  // 핫핑크 별
  const starCount=18;
  for (let i=0;i<starCount;i++){
    const sx = Math.floor(rand(12, BASE_W-12));
    const sy = Math.floor(rand(12, BASE_H-12));
    const outer = Math.random()<0.5 ? 6 : 7;
    const inner = Math.max(2, Math.round(outer*0.46));
    const rot = 0; // 0이면 픽셀 격자 정렬로 또렷
    drawStar(bgCtx, sx, sy, outer, inner, '#FF2E86', '#4d3d5a', rot);
  }
}
function drawBG(){ ctx.drawImage(bgCanvas,0,0); }
makeBG();

/* ====== 유틸 ====== */
function rand(a,b){ return a + Math.random()*(b-a); }
function pick(arr){ return arr[(Math.random()*arr.length)|0]; }
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

/* ====== 텍스트(중앙, 선명 외곽선) ====== */
function textC(t,y,size=16, fill='#5C4A72', stroke='#FFF6F9'){
  ctx.font=`${size}px "Galmuri11", monospace`; ctx.textAlign='center';
  const x=Math.round(BASE_W/2), yy=Math.round(y);
  if (stroke){
    ctx.fillStyle=stroke; ctx.fillText(t,x+1,yy); ctx.fillText(t,x-1,yy);
    ctx.fillText(t,x,yy+1); ctx.fillText(t,x,yy-1);
  }
  ctx.fillStyle=fill; ctx.fillText(t,x,yy);
}
function showMsg(t,dur=90){ msg=t; msgTimer=dur; }

/* ====== 플레이어(스프라이트 우선, 없으면 벡터) ====== */
const player={ x:BASE_W/2, y:BASE_H-52, w:22, h:28, vx:0, speed:1.1, maxV:2.4, anim:0 };
function drawPlayer(){
  const x=Math.round(player.x), y=Math.round(player.y);
  const moving = Math.abs(player.vx)>0.05;
  player.anim += 1;
  const frame = moving ? ( (Math.floor(player.anim/10)%2) ? 'run1' : 'run2' ) : 'idle';
  const spr = SPRITES.player[frame];
  if (spr){
    ctx.drawImage(spr, x-12, y-18, 24, 24);
  } else {
    const sway=Math.sin(performance.now()/240)*1.5;
    ctx.fillStyle='#5C4A72'; ctx.beginPath();
    ctx.moveTo(x-10,y+26); ctx.lineTo(x+10,y+26);
    ctx.lineTo(x+11,y+12+sway); ctx.lineTo(x-11,y+12-sway);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle='#7b5b3e'; ctx.beginPath(); ctx.ellipse(x,y,8,9,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#FF88A6'; ctx.fillRect(x-3,y-10,6,3);
    ctx.fillStyle='#FFF6F9'; ctx.fillRect(x-6,y+12,12,10);
    ctx.fillStyle='#C49A6C'; ctx.fillRect(x+9,y+12,8,8);
    ctx.strokeStyle='#8c6a45'; ctx.lineWidth=1; ctx.beginPath(); ctx.arc(x+13,y+12,4,Math.PI,0); ctx.stroke();
  }
}

/* ====== 아이템: 스프라이트 우선, 없으면 벡터 ====== */
const eatNames=['거북이','토마토','버섯'];
const avoidNames=['설탕','우유','계란','생크림','복숭아','젤라틴'];
function drawVectorItem(name,x,y,r){
  function outlineRect(a,b,c,d,color='#4d3d5a'){ ctx.strokeStyle=color; ctx.lineWidth=1; ctx.strokeRect(a+0.5,b+0.5,c,d); }
  function drawTurtle(cx,cy,r){
    ctx.fillStyle='#8DB38B'; ctx.beginPath(); ctx.ellipse(cx,cy,r,r*0.75,0,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#4d3d5a'; ctx.stroke();
    ctx.fillStyle='#9AD1D4'; ctx.beginPath(); ctx.arc(cx+r*0.9,cy-2,r*0.35,0,Math.PI*2); ctx.fill();
    ctx.fillRect(cx-r*0.7,cy+r*0.5,4,4); ctx.fillRect(cx+r*0.3,cy+r*0.5,4,4);
    ctx.fillStyle='#FFA3A3'; ctx.beginPath(); ctx.moveTo(cx-2,cy-r-2); ctx.lineTo(cx+8,cy-r-2); ctx.lineTo(cx+3,cy-r-10); ctx.closePath(); ctx.fill();
    ctx.strokeStyle='#4d3d5a'; ctx.beginPath(); ctx.moveTo(cx+3,cy-r-2); ctx.lineTo(cx+3,cy-6); ctx.stroke();
  }
  function drawTomato(cx,cy,r){
    ctx.fillStyle='#FF6B6B'; ctx.beginPath(); ctx.arc(cx,cy,r*0.9,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#4d3d5a'; ctx.stroke();
    ctx.fillStyle='#3FA34D'; ctx.beginPath(); ctx.moveTo(cx,cy-r*0.9); ctx.lineTo(cx-6,cy-4); ctx.lineTo(cx+6,cy-4); ctx.closePath(); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.7)'; ctx.beginPath(); ctx.arc(cx-4,cy-4,3,0,Math.PI*2); ctx.fill();
  }
  function drawMushroom(cx,cy,r){
    ctx.fillStyle='#D36B6B'; ctx.beginPath(); ctx.ellipse(cx,cy,r,r*0.6,0,Math.PI,0); ctx.fill(); ctx.strokeStyle='#4d3d5a'; ctx.stroke();
    ctx.fillStyle='#E6D7C3'; ctx.fillRect(cx-4,cy,8,r*0.9); outlineRect(cx-4,cy,8,r*0.9);
  }
  function drawSugar(cx,cy,r){ ctx.fillStyle='#FFF2A6'; ctx.fillRect(cx-r*0.8,cy-r*0.8,r*1.6,r*1.6); outlineRect(cx-r*0.8,cy-r*0.8,r*1.6,r*1.6); ctx.fillStyle='#FFFFFF'; ctx.fillRect(cx-6,cy-6,3,3); }
  function drawMilk(cx,cy,r){
    ctx.fillStyle='#F9FDFF'; ctx.beginPath(); ctx.moveTo(cx-10,cy+10); ctx.lineTo(cx-10,cy-6); ctx.lineTo(cx,cy-12); ctx.lineTo(cx+10,cy-6); ctx.lineTo(cx+10,cy+10); ctx.closePath(); ctx.fill(); ctx.strokeStyle='#4d3d5a'; ctx.stroke();
    ctx.fillStyle='#9AD1D4'; ctx.fillRect(cx-10,cy,20,6); outlineRect(cx-10,cy,20,6);
  }
  function drawEgg(cx,cy,r){ ctx.fillStyle='#FFE4A1'; ctx.beginPath(); ctx.ellipse(cx,cy,r*0.8,r,0,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#4d3d5a'; ctx.stroke(); }
  function drawCream(cx,cy,r){
    ctx.fillStyle='rgba(255,136,166,0.32)'; ctx.beginPath(); ctx.ellipse(cx+2,cy+2,r*0.9,r*0.55,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#FFE8F1'; ctx.beginPath(); ctx.moveTo(cx,cy-r*0.9);
    ctx.bezierCurveTo(cx+r*0.4,cy-r*0.8,cx+r*0.4,cy-r*0.2,cx,cy);
    ctx.bezierCurveTo(cx-r*0.4,cy+r*0.2,cx-r*0.4,cy-r*0.6,cx,cy-r*0.9); ctx.fill();
    ctx.strokeStyle='#4d3d5a'; ctx.stroke();
  }
  function drawPeach(cx,cy,r){ ctx.fillStyle='#FFD1B8'; ctx.beginPath(); ctx.arc(cx,cy,r*0.9,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#4d3d5a'; ctx.stroke();
    ctx.fillStyle='#3FA34D'; ctx.beginPath(); ctx.ellipse(cx+4,cy-8,6,3,-0.6,0,Math.PI*2); ctx.fill();
  }
  function drawGelatin(cx,cy,r){ ctx.fillStyle='#D7F6F0'; ctx.beginPath();
    ctx.moveTo(cx-r*0.9,cy+r*0.9); ctx.lineTo(cx-r*0.9,cy); ctx.quadraticCurveTo(cx,cy-r,cx+r*0.9,cy);
    ctx.lineTo(cx+r*0.9,cy+r*0.9); ctx.closePath(); ctx.fill(); ctx.strokeStyle='#4d3d5a'; ctx.stroke();
  }
  switch(name){
    case '거북이': drawTurtle(x,y,r); break;
    case '토마토': drawTomato(x,y,r); break;
    case '버섯'  : drawMushroom(x,y,r); break;
    case '설탕'  : drawSugar(x,y,r); break;
    case '우유'  : drawMilk(x,y,r); break;
    case '계란'  : drawEgg(x,y,r); break;
    case '생크림': drawCream(x,y,r); break;
    case '복숭아': drawPeach(x,y,r); break;
    case '젤라틴': drawGelatin(x,y,r); break;
  }
}
function drawItem(it){
  const x=Math.round(it.x), y=Math.round(it.y);
  const spr=SPRITES.items[it.name];
  if (spr){ const size=16; ctx.drawImage(spr, x-size/2, y-size/2, size, size); }
  else { drawVectorItem(it.name, x, y, it.r); }
}

/* ====== 충돌 ====== */
function collide(px,py,pw,ph, ix,iy,ir){
  const ax=px, ay=py, aw=pw, ah=ph;
  const bx=ix-ir, by=iy-ir, bw=ir*2, bh=ir*2;
  return (ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by);
}

/* ====== 난이도/스폰(빠르고 조금 더 많이) ====== */
let items=[], spawnTick=0;
function spawnLimits(){
  const maxItems=Math.min(9+Math.floor(stage*1.7), 20); // 동시 수량 상한
  const attempts=1+Math.floor(stage/3);                  // 초당 시도
  const prob=0.13+stage*0.022;                           // 스폰 확률
  return { maxItems, attempts, prob };
}
function fallSpeedFactor(){ return 1 + (stage-1)*0.30; }
function spawnItem(){
  const isGood=Math.random()<0.6;
  const name=isGood ? pick(eatNames) : pick(avoidNames);
  const base=0.95 + (stage-1)*0.16;
  const vy=(rand(base, base+0.65) + (isGood?0:0.06)) * fallSpeedFactor();
  items.push({ name, good:isGood, x:rand(28,BASE_W-28), y:-26, r:14, vy });
}

/* ====== HUD/포스터 ====== */
function drawHUD(){
  ctx.fillStyle='rgba(255,255,255,0.78)'; ctx.fillRect(0,0,BASE_W,86);
  textC(`STAGE ${stage}`,18,16,'#5C4A72','#FFFFFF');
  textC(`SCORE ${score}  |  BEST ${hi}`,36,14,'#5C4A72','#FFFFFF');
  const cx=Math.floor(BASE_W/2), w=Math.floor(BASE_W*0.66);
  ctx.fillStyle='#FDE2FF'; ctx.fillRect(cx-w/2,50,w,10);
  ctx.fillStyle='#C9A7EB'; ctx.fillRect(cx-w/2,50,Math.floor(w*Math.min(1,score/TARGET_SCORE)),10);
  textC('미션 10000',46,12,'#5C4A72','#FFFFFF');
  ctx.fillStyle='#E8DFF8'; ctx.fillRect(cx-w/2,66,w,8);
  ctx.fillStyle='#9AD1D4'; ctx.fillRect(cx-w/2,66,Math.floor(w*(progress/goal)),8);
  textC('먹기',62,12,'#5C4A72','#FFFFFF');
  ctx.fillStyle='#FFE5EC'; ctx.fillRect(cx-w/2,80,w,6);
  ctx.fillStyle='#FF88A6'; ctx.fillRect(cx-w/2,80,Math.floor(w*(cavity/100)),6);
  textC('충치',76,12,'#5C4A72','#FFFFFF');
  ctx.font='12px "Galmuri11"'; ctx.textAlign='center'; ctx.fillStyle='#5C4A72';
  const volLabel=audioEnabled? `${Math.round(volumeSteps[volIdx]*100)}%` : 'OFF';
  ctx.fillText(`음향 ${volLabel}  (M 토글 · [ ] 볼륨)`, BASE_W/2, 100);
}
function drawAvoidPoster(){
  const x=32,y=200,w=BASE_W-64,h=152;
  ctx.fillStyle='rgba(255,255,255,0.85)'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle='#5C4A72'; ctx.strokeRect(x+0.5,y+0.5,w-1,h-1);
  textC('달콤하긴 하지만.. 피하자!', y+22,16,'#5C4A72','#FFF6F9');
  const slots=[
    {name:'설탕'}, {name:'우유'}, {name:'계란'},
    {name:'생크림'}, {name:'복숭아'}, {name:'젤라틴'},
  ];
  const cols=3, dx=w/(cols+1), dy=54;
  for (let i=0;i<slots.length;i++){
    const col=i%cols, row=(i/cols)|0;
    const cx=x+dx*(col+1), cy=y+46+dy*row;
    drawItem({name:slots[i].name, x:cx, y:cy, r:16});
    ctx.strokeStyle='#FF2E86'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(cx-18,cy-18); ctx.lineTo(cx+18,cy+18); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx+18,cy-18); ctx.lineTo(cx-18,cy+18); ctx.stroke();
    ctx.font='12px "Galmuri11"'; ctx.textAlign='center'; ctx.fillStyle='#5C4A72';
    ctx.fillText(slots[i].name, Math.round(cx), Math.round(cy+26));
  }
}

/* ====== 흐름 제어 ====== */
function textHint(){
  textC('계량 실패! 양과자점!', 62, 22,'#5C4A72','#FFF6F9');
  textC('충치를 남기자!', 86, 16,'#FF88A6','#FFFFFF');
  if ((Math.floor(performance.now()/400)%2)===0) textC('즐거운 마음으로 시작하기', 110, 14,'#5C4A72','#FFFFFF');
  textC('스페이스/엔터: 시작  ·  M: 음향 토글  ·  [ ]: 볼륨', 132, 12,'#5C4A72','#FFFFFF');
}
function startGame(){
  state='play'; stage=1; progress=0; goal=12; cavity=0; score=0;
  items.length=0; spawnTick=0; msg=''; msgTimer=0;
  player.x=BASE_W/2; player.vx=0; player.anim=0;
  ensureAudio(); updateMasterGain(); if (audioEnabled) startChiptune();
}
function nextStage(){
  stage++; score+=500; progress=0; goal=12+(stage-1)*5;
  showMsg(`스테이지 ${stage} 시작!`,80); sfx('stage');
}
function victory(){
  state='victory'; stopChiptune(); sfx('win');
  if (score>hi){ hi=score; localStorage.setItem('ygj_hi_full', String(hi)); }
}
function goTitle(){ state='title'; items.length=0; stopChiptune(); }
function gameOver(){
  state='gameover'; stopChiptune();
  if (score>hi){ hi=score; localStorage.setItem('ygj_hi_full', String(hi)); }
}

/* ====== 업데이트 ====== */
function update(dt){
  const left=key['ArrowLeft']||key['a']||key['A']||touchLeft;
  const right=key['ArrowRight']||key['d']||key['D']||touchRight;
  if (left && !right) player.vx=clamp(player.vx - player.speed*dt, -player.maxV, player.maxV);
  else if (right && !left) player.vx=clamp(player.vx + player.speed*dt, -player.maxV, player.maxV);
  else { player.vx*= (1-0.18*dt); if (Math.abs(player.vx)<0.02) player.vx=0; }
  player.x=clamp(player.x+player.vx, 24, BASE_W-24);

  const {maxItems, attempts, prob}=spawnLimits();
  spawnTick+=dt;
  if (spawnTick>=1){
    if (items.length<maxItems){
      for (let i=0;i<attempts;i++) if (Math.random()<prob) spawnItem();
    }
    spawnTick=0;
  }

  for (let i=items.length-1; i>=0; i--){
    const it=items[i]; it.y += it.vy*dt;
    if (collide(player.x-11, player.y, 22, 28, it.x, it.y, it.r)){
      if (it.good){
        progress++; score += 130 + stage*16;
        showMsg(`${it.name} 획득! (${progress}/${goal})`, 45);
        sfx('ok'); vibrate(12);
        if (progress>=goal) nextStage();
        if (score>=TARGET_SCORE) victory();
      } else {
        cavity=Math.min(100, cavity+20);
        showMsg('달콤하긴 하지만.. 피하자!', 50);
        sfx('bad'); vibrate(28);
        if (cavity>=100) gameOver();
      }
      items.splice(i,1);
    } else if (it.y>BASE_H+24){ items.splice(i,1); }
  }
}

/* ====== 그리기 ====== */
function drawTitle(){
  drawBG();
  ctx.fillStyle='rgba(255,255,255,0.85)'; ctx.fillRect(24,28,BASE_W-48,100);
  ctx.strokeStyle='#5C4A72'; ctx.strokeRect(24.5,28.5,BASE_W-49,99);
  textHint();
  drawPlayer(); drawAvoidPoster();
}
function drawGame(){
  drawBG();
  for (const it of items) drawItem(it);
  drawPlayer(); drawHUD();
  if (msgTimer>0){
    const w=BASE_W-140, x=(BASE_W-w)/2, y=112;
    ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.fillRect(x,y,w,22);
    ctx.strokeStyle='#5C4A72'; ctx.strokeRect(x+0.5,y+0.5,w-1,21);
    textC(msg, y+16, 14,'#5C4A72','#FFFFFF'); msgTimer-=1;
  }
}
function drawVictory(){
  // 심플 패널(이전 스타일)
  ctx.fillStyle='rgba(0,0,0,0.35)'; ctx.fillRect(0,0,BASE_W,BASE_H);
  ctx.fillStyle='#FFF6F9'; ctx.fillRect(64, 96, BASE_W-128, 120);
  ctx.strokeStyle='#5C4A72'; ctx.strokeRect(64.5,96.5,BASE_W-129,119);
  textC('미션 성공! 🍰', 132, 18,'#5C4A72','#FFFFFF');
  textC(`점수 ${score}  |  최고 ${hi}`, 156, 14,'#5C4A72','#FFFFFF');
  textC('스페이스/엔터: 타이틀로', 180, 14,'#5C4A72','#FFFFFF');
}
function drawOver(){
  ctx.fillStyle='rgba(0,0,0,0.35)'; ctx.fillRect(0,0,BASE_W,BASE_H);
  ctx.fillStyle='#FFF6F9'; ctx.fillRect(64, 100, BASE_W-128, 100);
  ctx.strokeStyle='#5C4A72'; ctx.strokeRect(64.5,100.5,BASE_W-129,99);
  textC('계량 실패...!', 128, 18,'#5C4A72','#FFFFFF');
  textC(`점수 ${score}  |  최고 ${hi}`, 154, 14,'#5C4A72','#FFFFFF');
  textC('스페이스/엔터: 타이틀로', 180, 14,'#5C4A72','#FFFFFF');
}

/* ====== 루프 ====== */
let last=performance.now();
function loop(now){
  const dt=(now-last)/16.6667; last=now;
  if (state==='title') drawTitle();
  else if (state==='play'){ update(dt); drawGame(); }
  else if (state==='victory'){ drawGame(); drawVictory(); }
  else if (state==='gameover'){ drawGame(); drawOver(); }
  requestAnimationFrame(loop);
}
if (document.fonts && document.fonts.ready){ document.fonts.ready.then(()=>{ requestAnimationFrame(loop); }); }
else { requestAnimationFrame(loop); }
</script>
</body>
</html>